local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local RANGE = 8
local WIDTH = 0.1
local COLOR = ColorSequence.new(Color3.fromRGB(0, 255, 0))
local OFFSET_Y = 2 -- HRPより上（頭くらい）

local function createBeam(character)
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    -- 終点パート
    local endPart = Instance.new("Part")
    endPart.Size = Vector3.new(0.1, 0.1, 0.1)
    endPart.Transparency = 1
    endPart.CanCollide = false
    endPart.Anchored = true
    endPart.Name = "__BeamEnd"
    endPart.Parent = workspace

    -- Attachment0（頭の位置に調整）
    local a1 = Instance.new("Attachment")
    a1.Name = "LaserStart"
    a1.Parent = hrp
    a1.Position = Vector3.new(0, OFFSET_Y, 0)

    -- Attachment1
    local a2 = Instance.new("Attachment")
    a2.Name = "LaserEnd"
    a2.Parent = endPart

    -- Beam
    local beam = Instance.new("Beam")
    beam.Attachment0 = a1
    beam.Attachment1 = a2
    beam.Width0 = WIDTH
    beam.Width1 = WIDTH
    beam.Color = COLOR
    beam.Transparency = NumberSequence.new(0) -- 濃い
    beam.FaceCamera = false
    beam.LightInfluence = 0
    beam.Segments = 1
    beam.Parent = hrp -- どこでも OK

    -- 位置更新
    RunService.RenderStepped:Connect(function()
        if not hrp.Parent then return end

        -- 頭の位置
        local origin = hrp.Position + Vector3.new(0, OFFSET_Y, 0)
        a1.Position = Vector3.new(0, OFFSET_Y, 0) -- ずっと同じ位置

        -- 前へ8スタッド
        local target = hrp.Position + Vector3.new(0, OFFSET_Y, 0) + hrp.CFrame.LookVector * RANGE
        endPart.CFrame = CFrame.new(target)
    end)
end

-- 全プレイヤーに適用
for _, plr in ipairs(Players:GetPlayers()) do
    if plr.Character then createBeam(plr.Character) end
    plr.CharacterAdded:Connect(function(char)
        char:WaitForChild("HumanoidRootPart")
        createBeam(char)
    end)
end

Players.PlayerAdded:Connect(function(plr)
    plr.CharacterAdded:Connect(function(char)
        char:WaitForChild("HumanoidRootPart")
        createBeam(char)
    end)
end)
